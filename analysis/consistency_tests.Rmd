---
title: "Consistency tests"
author: "LMM"
date: "17 de julio de 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(tidyverse)
library(asnipe)
library(igraph)
source('R/cmbDFrame.r')
source('R/exx_calculation.r')
source('R/exy_calculation.r')
source('R/Permutational_community_assortativity.r')
source('R/getNetworkCommunities.r')
source('R/xy_subsets.r')
source('R/adj_to_edgelist.r')
source('R/rcom.R')
data('group_by_individual')
```

The following are the data used in [Shizuka et al. (2016)](https://www.sciencedirect.com/science/article/pii/S0003347215004480?via%3Dihub)

```{r original datasets}
sparrow <- read.csv(url('https://datadryad.org/bitstream/handle/10255/dryad.63926/Flock_Season3_Dryad.csv'), na.strings = c('NA', ' ', ''),
                    colClasses = c(rep('factor', 3), rep('character', 10)))

tit <- gbi

thornbill <- read.csv('data/mmc1.csv')
```

#1. Sparrow data

```{r sparrow data}
sparrow_el <- sparrow %>% 
    select(-c(1:3)) %>%
    cmbDFrame()

sparrow_wel <- sparrow_el$mrgCCombs %>% 
    data.frame() %>%
    mutate(X1 = as.character(X1), X2 = as.character(X2))
```


```{r sparrow simple ratio association index}
sparrow_wel$weight <- 0

for(i in 1:nrow(unique(sparrow_wel))) {
    RowsOcurrency <- rowSums(t(apply(sparrow_wel, 1, function(x) x %in%  unique(sparrow_wel)[i, ]))) == 2
    
    A <- sum(RowsOcurrency)


    if(unique(sparrow_wel)[i, 2] == "") {
        B <- sum(sparrow_wel == unique(sparrow_wel)[i, 1])
        } else {
         B <- sum(sparrow_wel == unique(sparrow_wel)[i, 1],
             sparrow_wel == unique(sparrow_wel)[i, 2])   
        }

    ##we apply the operation A/(B-A) given that by calculating the sum of the frecuency of A and B we are adding twice the value of the interaction A*B.
    sparrow_wel$weight[RowsOcurrency] <- A/(B-A)

print(paste(round(100*i/nrow(unique(sparrow_wel)), 1), "%"))
}

sparrow_wel <- sparrow_wel[sparrow_wel$X2 != '',] #Discard solitary individuals
```

#the following is an alternative using the asnipe package

```{r sparrow data}
sparrow_inds <- sparrow %>%
    select(-c(1:3)) %>% 
    t() %>% 
    data.frame() %>% 
    gather(key = 'Group', value = 'ID') %>%
    filter(ID != 'NA') %>%
    select(ID, Group) %>% 
    get_group_by_individual(data_format = 'individuals')
```

```{r}
#sparrow_g <- sparrow_inds %>% 
#    get_network(data_format = "GBI", association_index ="SRI") %>%
#    graph.adjacency(mode = "undirected", weighted = TRUE)
```

```{r sparrows graphs}
sparrow_g <- graph_from_data_frame(sparrow_wel, directed = FALSE) 

sparrow_g <- simplify(sparrow_g)#Discard multiple edges
#sparrow_g <- graph.adjacency(network, mode = "undirected", weighted = TRUE)

sparrow_dis <- cluster_fast_greedy(sparrow_g) #discrete communities
#plot(sparrow_comm, sparrow_g)

sparrow_over <- getLinkCommunities(sparrow_wel) #overlapping communities
#plotLinkCommGraph(sparrow_over)
```

Now we can compare the consistency of the proposed metric

```{r sparrows rov}
Pij_comm <- calc_Pmatrix(sparrow_g, 100, 'linkcomm')

Exx <- rcomm_exx(Pij_comm)
Exy <- rcomm_exy(Pij_comm)

rov_spa <- (Exx - Exy)/(1 - Exy)
print(rov_spa)
```

```{r sparrows rcom}
rcom_spa <- calc_rc(sparrow_inds, plot.result = FALSE)
print(rcom_spa)
```

Shizuka’s coefficient: 0.83 (the value reported in their papers was 0.81)
Ascanio’s coefficient (for overlapping communities): 0.43

#2. Tit data

```{r tits graph}
tit_g <- tit %>% 
    get_network(data_format = "GBI", association_index ="SRI") %>%
    graph.adjacency(mode = "undirected", weighted = TRUE)

tit_dis <- cluster_fast_greedy(tit_g) #4 comms != 3 as reported by shizuka et al

tit_over <- getLinkCommunities(get.edgelist(tit_g), plot = FALSE) #24 comms
```

```{r tits rcom}
set.seed(1)
rcom_tit <- calc_rc(gbi, plot.result = FALSE)
print(rcom_tit)
```

Shizuka’s coefficient: 0.985 (the value reported in their papers was 0.99)

#3. Thornbill data

```{r thornbill graph}
tho_g <- thornbill %>% 
    select(-1) %>% 
    get_network(data_format = "GBI", association_index ="SRI") %>%
    graph.adjacency(mode = "undirected", weighted = TRUE)

tho_dis <- cluster_fast_greedy(tho_g) #3 comms

tho_over <- getLinkCommunities(get.edgelist(tho_g), plot = FALSE) #1 comms
```

```{r thornbill rcom}
set.seed(1)
rcom_tho <- calc_rc(thornbill, plot.result = FALSE)
```

Shizuka’s coefficient: 0.40 (the value reported in their papers was 0.46)