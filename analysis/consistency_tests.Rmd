---
title: "Consistency tests"
author: 'AA', 'LMM', 'JC', 'AC'
date: "17 de julio de 2018"
output: html_document
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, scripts, and data}
library(tidyverse)
library(asnipe)
library(igraph)
library(igraphdata)
library(linkcomm)
source('R/cmbDFrame.R')
source('R/exx_calculation.R')
source('R/exy_calculation.r')
source('R/Permutational_community_assortativity.r')
source('R/getNetworkCommunities.r')
source('R/xy_subsets.r')
source('R/adj_to_edgelist.r')
source('R/rcom.R')
```

The following are the data used in [Shizuka et al. (2016)](https://www.sciencedirect.com/science/article/pii/S0003347215004480?via%3Dihub)

#1. Sparrow data (Medium structure)

```{r sparrow data}
sparrow <- read.csv(url('https://datadryad.org/bitstream/handle/10255/dryad.63926/Flock_Season3_Dryad.csv'), na.strings = c('NA', ' ', ''),
                    colClasses = c(rep('factor', 3), rep('character', 10)))

sparrow_inds <- sparrow %>%
    select(-c(1:3)) %>%
    t() %>%
    data.frame() %>%
    gather(key = 'Group', value = 'ID') %>%
    filter(ID != 'NA') %>%
    select(ID, Group) %>%
    get_group_by_individual(data_format = 'individuals')
```

```{r sparrow graph}
sparrow_g <- sparrow_inds %>%
    get_network(data_format = "GBI", association_index ="SRI") %>%
    graph.adjacency(mode = "undirected", weighted = TRUE)
```


#2. Tit data (High structure)

```{r tits graph}
data('group_by_individual')

tit <- gbi

colnames(tit) <- paste("N", as.character(seq(1:ncol(tit))), sep = "")

tit_g <- tit %>%
    get_network(data_format = "GBI", association_index ="SRI") %>%
    graph.adjacency(mode = "undirected", weighted = TRUE)

#V(tit_g)$name <- paste("N", as.character(V(tit_g)), sep = "")
```

# 3. Thornbill data (low structure)

```{r thornbill graph}
thornbill <- read.csv('data/mmc1.csv')

tho_g <- thornbill %>%
    select(-1) %>%
    get_network(data_format = "GBI", association_index ="SRI") %>%
    graph.adjacency(mode = "undirected", weighted = TRUE)
```

# 4. UK faculty dataset

Nepusz T., Petroczi A., Negyessy L., Bazso F.: Fuzzy communities and the concept of bridgeness in complex networks. Physical Review E 77:016107, 2008. 

```{r}
data('UKfaculty')

uk_raw <- get.edgelist(UKfaculty) %>%
    as.data.frame() %>% 
    mutate(weights = E(UKfaculty)$weight) %>% 
    uncount(weights)

uk_g <- UKfaculty
```

# 5. US airports dataset

```{r}
data('USairports')

usair_raw <- get.edgelist(USairports) %>% 
    as.data.frame()

usair_g <- USairports
E(usair_g)$weight <- rep(1,length(E(usair_g)))
usair_g <- simplify(usair_g, remove.multiple = T, edge.attr.comb = 'sum')
```

# 6. Hospital encounter network data

P. Vanhems, A. Barrat, C. Cattuto, J.-F. Pinton, N. Khanafer, C. Regis, B.-a. Kim, B. Comte, N. Voirin: Estimating potential infection transmission routes in hospital wards using wearable proximity sensors. PloS One 8(9), e73970 306 (2013). 

```{r}
data(rfid)

rfid_raw <- get.edgelist(USairports) %>% 
    as.data.frame()

rfid_g <- rfid
E(rfid_g)$weight <- rep(1,length(E(rfid_g)))
rfid_g <- simplify(rfid_g, remove.multiple = T, edge.attr.comb = 'sum')
```

# 7. Enron Email Network 

```{r}
data(enron)

enron_raw <- get.edgelist(enron) %>% 
    as.data.frame()

enron_g <- enron
E(enron_g)$weight <- rep(1,length(E(enron_g)))
enron_g <- simplify(enron_g, remove.multiple = T, edge.attr.comb = list(weight="sum", "ignore"))
```

# 8. Random data

```{r random graph}
set.seed(1)

rnd_raw <- matrix(rbinom(10000, 1, 0.5), ncol=50) %>%
    data.frame()

rnd_g <- rnd_raw %>%
    get_network(data_format = "GBI", association_index ="SRI") %>%
    graph.adjacency(mode = "undirected", weighted = TRUE)
```




Now we can compare the consistency of the proposed metric

```{r sparrows rov}
set.seed(1)
Pij_comm <- calc_Pmatrix(sparrow_g, 100, 'linkcomm')

Exx <- rcomm_exx(Pij_comm)
Exy <- rcomm_exy(Pij_comm)

rov_spa <- (Exx - Exy)/(1 - Exy)
print(rov_spa)
```

```{r sparrows rcom}
set.seed(1)
rcom_spa <- calc_rc(sparrow_inds, plot.result = FALSE)
print(rcom_spa)
```

```{r sparrows permutation rov discrete}
set.seed(1)
Pij_spa_dis <- calc_Pmatrix(sparrow_g, 100, 'fastgreedy')

Exx_spa_dis <- rcomm_exx(Pij_spa_dis)
Exy_spa_dis <- rcomm_exy(Pij_spa_dis)

rov_spa_dis <- (Exx_spa_dis - Exy_spa_dis)/(1 - Exy_spa_dis)
print(rov_spa_dis)
```

```{r sparrows bootstrap fastgreedy}
set.seed(1)
Pij_comm <- calc_Pmatrix(sparrow_g, 100, 'fastgreedy', permutations = F, boot.data = sparrow_inds)

Exx <- rcomm_exx(Pij_comm)
Exy <- rcomm_exy(Pij_comm)

rov_spa <- (Exx - Exy)/(1 - Exy)
print(rov_spa)
```


 * Shizuka’s coefficient (fastgreedy, bootstrap): 0.83 (the value reported in their papers was 0.81).
 * Ascanio's coefficient (fastgreedy, bootstrap): 0.90
 * Ascanio’s coefficient (linkcomm, permutations): 0.57
 * Ascanio’s coefficient (fastgreedy, permutations): 0.36

#2. Tit data (High structure)

```{r tits graph}
colnames(tit) <- paste("N", as.character(seq(1:ncol(tit))), sep = "")

tit_g <- tit %>%
    get_network(data_format = "GBI", association_index ="SRI") %>%
    graph.adjacency(mode = "undirected", weighted = TRUE)

#V(tit_g)$name <- paste("N", as.character(V(tit_g)), sep = "")
```

```{r tits rcom}
set.seed(1)
rcom_tit <- calc_rc(gbi, plot.result = FALSE)
print(rcom_tit)
```

```{r tits rov linkcomm}
set.seed(1)
Pij_tit_over <- calc_Pmatrix(tit_g, 100, 'linkcomm')

Exx_tit_over <- rcomm_exx(Pij_tit_over)
Exy_tit_over <- rcomm_exy(Pij_tit_over)

rov_tit_over <- (Exx_tit_over - Exy_tit_over)/(1 - Exy_tit_over)
print(rov_tit_over)
```

```{r tits rov discrete using permutations}
set.seed(1)

Pij_tit_dis <- calc_Pmatrix(tit_g, 100, 'fastgreedy')

Exx_tit_dis <- rcomm_exx(Pij_tit_dis)
Exy_tit_dis <- rcomm_exy(Pij_tit_dis)

rov_tit_dis <- (Exx_tit_dis - Exy_tit_dis)/(1 - Exy_tit_dis)

print(rov_tit_dis)
```

```{r tits rov discrete using bootstrap}
set.seed(1)

Pij_tit_dis_b <- calc_Pmatrix(tit_g, 100, 'fastgreedy', permutations = F, boot.data = tit)

Exx_tit_dis_b <- rcomm_exx(Pij_tit_dis_b)
Exy_tit_dis_b <- rcomm_exy(Pij_tit_dis_b)

rov_tit_dis_b <- (Exx_tit_dis_b - Exy_tit_dis_b)/(1 - Exy_tit_dis_b)

print(rov_tit_dis_b)
```

 * Shizuka’s coefficient (fastgreedy, bootstrap): 0.985
 * Ascanio’s coefficient (fastgreedy, bootstrap): 0.99
 * Ascanio’s coefficient (linkcomm, permutations): 0.47
 * Ascanio’s coefficient (fastgreedy, permutations): 0.33

# 3. Thornbill data (low structure)

```{r thornbill graph}
tho_g <- thornbill %>%
    select(-1) %>%
    get_network(data_format = "GBI", association_index ="SRI") %>%
    graph.adjacency(mode = "undirected", weighted = TRUE)
```

```{r thornbill rcom}
set.seed(1)
rcom_tho <- calc_rc(thornbill, plot.result = FALSE)
print(rcom_tho)
```

```{r thornbill linkcomm}
set.seed(1)
Pij_tho_over <- calc_Pmatrix(tho_g, 100, 'linkcomm')

Exx_tho_over <- rcomm_exx(Pij_tho_over)
Exy_tho_over <- rcomm_exy(Pij_tho_over)

rov_tho_over <- (Exx_tho_over - Exy_tho_over)/(1 - Exy_tho_over)
print(rov_tho_over)
```

```{r thornbill rov discrete with permutations}
set.seed(1)
Pij_tho_dis_p <- calc_Pmatrix(tho_g, 100, 'fastgreedy')

Exx_tho_dis_p <- rcomm_exx(Pij_tho_dis_p)
Exy_tho_dis_p <- rcomm_exy(Pij_tho_dis_p)

rov_tho_dis_p <- (Exx_tho_dis_p - Exy_tho_dis_p)/(1 - Exy_tho_dis_p)

print(rov_tho_dis_p)
```

```{r thornbill rov discrete bootstrap}
set.seed(1)
Pij_tho_dis_b <- calc_Pmatrix(tho_g, 100, 'fastgreedy', permutations = F, boot.data = thornbill)

Exx_tho_dis_b <- rcomm_exx(Pij_tho_dis_b)
Exy_tho_dis_b <- rcomm_exy(Pij_tho_dis_b)

rov_tho_dis_b <- (Exx_tho_dis_b - Exy_tho_dis_b)/(1 - Exy_tho_dis_b)

print(rov_tho_dis_b)
```

 * Shizuka’s coefficient (fastgreedy, bootstrap): 0.40 (the value reported in their papers was 0.46)
 * Ascanio’s coefficient (linkcomm, permutations): 0.97
 * Ascanio’s coefficient (fastgreedy, permutations): 0.33
 * Ascanio’s coefficient (fastgreedy, bootstrap): 0.62

# 4. Random data

We generate random sampling data (50 spp and 200 samples) and then we apply the same association index as
the previous matrices

```{r random graph}
set.seed(1)

rnd_data <- matrix(rbinom(10000, 1, 0.5), ncol=50) %>%
    data.frame()

rnd_g <- rnd_data %>%
    get_network(data_format = "GBI", association_index ="SRI") %>%
    graph.adjacency(mode = "undirected", weighted = TRUE)
```


```{r random network rov linkcomm}
Pij_rnd_over <- calc_Pmatrix(rnd_g, 100, 'linkcomm')

Exx_rnd_over <- rcomm_exx(Pij_rnd_over)
Exy_rnd_over <- rcomm_exy(Pij_rnd_over)

rov_rnd_over <- (Exx_rnd_over - Exy_rnd_over)/(1 - Exy_rnd_over)

print(rov_rnd_over)
```

```{r random shizuka rcom}
set.seed(1)

rcom_rnd <- calc_rc(get.adjacency(rnd_g), plot.result = FALSE)

print(rcom_rnd)
```

```{r random fastgreedy with permutations}
set.seed(1)

Pij_rnd_dis_p <- calc_Pmatrix(rnd_g, 100, 'fastgreedy')

Exx_rnd_dis_p <- rcomm_exx(Pij_rnd_dis_p)
Exy_rnd_dis_p <- rcomm_exy(Pij_rnd_dis_p)

rov_rnd_dis_p <- (Exx_rnd_dis_p - Exy_rnd_dis_p)/(1 - Exy_rnd_dis_p)
print(rov_rnd_dis_p)
```

```{r random fastgreedy with bootstrap}
set.seed(1)

Pij_rnd_dis_b <- calc_Pmatrix(rnd_g, 100, 'fastgreedy', permutations = F,
                              boot.data = rnd_data)

Exx_rnd_dis_b <- rcomm_exx(Pij_rnd_dis_b)
Exy_rnd_dis_b <- rcomm_exy(Pij_rnd_dis_b)

rov_rnd_dis_b <- (Exx_rnd_dis_b - Exy_rnd_dis_b)/(1 - Exy_rnd_dis_b)
print(rov_rnd_dis_b)
```

 * Shizuka’s coefficient (fastgreedy, bootstrap): 0.001
 * Ascanio’s coefficient (linkcomm, permutations): 1
 * Ascanio’s coefficient (fastgreedy, bootstrap): 0.55
 * Ascanio’s coefficient (fastgreedy, permutations): 0.50

