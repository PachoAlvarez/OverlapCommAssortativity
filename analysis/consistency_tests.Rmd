---
title: "Consistency tests"
author: "LMM"
date: "17 de julio de 2018"
output: html_document
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(tidyverse)
library(asnipe)
library(igraph)
library(linkcomm)
source('R/cmbDFrame.R')
source('R/exx_calculation.R')
source('R/exy_calculation.r')
source('R/Permutational_community_assortativity.r')
source('R/getNetworkCommunities.r')
source('R/xy_subsets.r')
source('R/adj_to_edgelist.r')
source('R/rcom.R')
data('group_by_individual')
```

The following are the data used in [Shizuka et al. (2016)](https://www.sciencedirect.com/science/article/pii/S0003347215004480?via%3Dihub)

```{r original datasets}
sparrow <- read.csv(url('https://datadryad.org/bitstream/handle/10255/dryad.63926/Flock_Season3_Dryad.csv'), na.strings = c('NA', ' ', ''),
                    colClasses = c(rep('factor', 3), rep('character', 10)))

tit <- gbi

thornbill <- read.csv('data/mmc1.csv')
```

#1. Sparrow data

```{r sparrow data}
sparrow_inds <- sparrow %>%
    select(-c(1:3)) %>%
    t() %>%
    data.frame() %>%
    gather(key = 'Group', value = 'ID') %>%
    filter(ID != 'NA') %>%
    select(ID, Group) %>%
    get_group_by_individual(data_format = 'individuals')
```

```{r sparrow graph}
sparrow_g <- sparrow_inds %>%
    get_network(data_format = "GBI", association_index ="SRI") %>%
    graph.adjacency(mode = "undirected", weighted = TRUE)
```

Now we can compare the consistency of the proposed metric

```{r sparrows rov}
set.seed(1)
Pij_comm <- calc_Pmatrix(sparrow_g, 100, 'linkcomm')

Exx <- rcomm_exx(Pij_comm)
Exy <- rcomm_exy(Pij_comm)

rov_spa <- (Exx - Exy)/(1 - Exy)
print(rov_spa)
```

```{r sparrows rcom}
set.seed(1)
rcom_spa <- calc_rc(sparrow_inds, plot.result = FALSE)
print(rcom_spa)
```

```{r sparrows rov discrete}
set.seed(1)
Pij_spa_dis <- calc_Pmatrix(sparrow_g, 100, 'fastgreedy')

Exx_spa_dis <- rcomm_exx(Pij_spa_dis)
Exy_spa_dis <- rcomm_exy(Pij_spa_dis)

rov_spa_dis <- (Exx_spa_dis - Exy_spa_dis)/(1 - Exy_spa_dis)
print(rov_spa_dis)
```


Shizuka’s coefficient: 0.83 (the value reported in their papers was 0.81)
Ascanio’s coefficient: 0.43 (for overlapping communities)
Ascanio’s coefficient: 0.15 (for fast greedy communities)

#2. Tit data

```{r tits graph}
tit_g <- tit %>%
    get_network(data_format = "GBI", association_index ="SRI") %>%
    graph.adjacency(mode = "undirected", weighted = TRUE)

V(tit_g)$name <- paste("N", as.character(V(tit_g)), sep = "")
```

```{r tits rcom}
set.seed(1)
rcom_tit <- calc_rc(gbi, plot.result = FALSE)
print(rcom_tit)
```

```{r tits rov linkcomm}
set.seed(1)
Pij_tit_over <- calc_Pmatrix(tit_g, 100, 'linkcomm')

Exx_tit_over <- rcomm_exx(Pij_tit_over)
Exy_tit_over <- rcomm_exy(Pij_tit_over)

rov_tit_over <- (Exx_tit_over - Exy_tit_over)/(1 - Exy_tit_over)
print(rov_tit_over)
```

```{r tits rov discrete}
set.seed(1)

Pij_tit_dis <- calc_Pmatrix(tit_g, 100, 'fastgreedy')

Exx_tit_dis <- rcomm_exx(Pij_tit_dis)
Exy_tit_dis <- rcomm_exy(Pij_tit_dis)

rov_tit_dis <- (Exx_tit_dis - Exy_tit_dis)/(1 - Exy_tit_dis)

print(rov_tit_dis)
```


Shizuka’s coefficient: 0.985
Ascanio’s coefficient: 0.47 (for overlapping communities)
Ascanio’s coefficient: 0.30 (for fast greedy communities)

#3. Thornbill data

```{r thornbill graph}
tho_g <- thornbill %>%
    select(-1) %>%
    get_network(data_format = "GBI", association_index ="SRI") %>%
    graph.adjacency(mode = "undirected", weighted = TRUE)
```

```{r thornbill rcom}
set.seed(1)
rcom_tho <- calc_rc(thornbill, plot.result = FALSE)
print(rcom_tho)
```

```{r thornbill linkcomm}
set.seed(1)
Pij_tho_over <- calc_Pmatrix(tho_g, 100, 'linkcomm')

Exx_tho_over <- rcomm_exx(Pij_tho_over)
Exy_tho_over <- rcomm_exy(Pij_tho_over)

rov_tho_over <- (Exx_tho_over - Exy_tho_over)/(1 - Exy_tho_over)
print(rov_tho_over)
```

```{r thornbill rov discrete}
set.seed(1)
Pij_tho_dis <- calc_Pmatrix(tho_g, 100, 'fastgreedy')

Exx_tho_dis <- rcomm_exx(Pij_tho_dis)
Exy_tho_dis <- rcomm_exy(Pij_tho_dis)

rov_tho_dis <- (Exx_tho_dis - Exy_tho_dis)/(1 - Exy_tho_dis)

print(rov_tho_dis)
```

Shizuka’s coefficient: 0.40 (the value reported in their papers was 0.46)
Ascanio’s coefficient: 0.97 (for overlapping communities)
Ascanio’s coefficient: 0.30 (for fast greedy communities)

```{r random network}
set.seed(1)
rnd_g <- sample_gnp(50,0.5)
V(rnd_g)$name <- paste("N", as.character(V(rnd_g)), sep = "")
E(rnd_g)$weight <- sample(length(E(rnd_g)))
```

```{r random network rov linkcomm}
Pij_rnd_over <- calc_Pmatrix(rnd_g, 100, 'linkcomm')

Exx_rnd_over <- rcomm_exx(Pij_rnd_over)
Exy_rnd_over <- rcomm_exy(Pij_rnd_over)

rov_rnd_over <- (Exx_rnd_over - Exy_rnd_over)/(1 - Exy_rnd_over)

print(rov_rnd_over)
```

